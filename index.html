<!DOCTYPE html>
<html>
<head>
  <title>IGC HK Admin Panel</title>
  <style>
    body {
      background-color: #fdf6a6;
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
    }
    input, button {
      padding: 8px;
      margin: 8px;
    }
    .user-entry {
      margin-bottom: 20px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>IGC HK Admin Panel</h1>
  <p>Assign file URLs to users</p>
  <div id="userList">Loading users...</div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-functions.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBL-biUfPdgOoJvqgpD-drdcCNVXERlJ6Y",
      authDomain: "igchkwebsite.firebaseapp.com",
      projectId: "igchkwebsite",
      storageBucket: "igchkwebsite.appspot.com",
      messagingSenderId: "575146782620",
      appId: "1:575146782620:web:36853d54456714d5d6e259"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const adminEmail = "admin@igchkshop.dpdns.org"; // Replace with your actual admin email

    onAuthStateChanged(auth, async (user) => {
      if (user && user.email === adminEmail) {
        loadUserList();
      } else {
        const email = prompt("Admin Email:");
        const password = prompt("Password:");
        try {
          const result = await signInWithEmailAndPassword(auth, email, password);
          if (result.user.email !== adminEmail) {
            alert("Access denied: not admin");
          }
        } catch (e) {
          alert("Login failed: " + e.message);
        }
      }
    });

    async function loadUserList() {
      const userListDiv = document.getElementById("userList");

      const response = await fetch("https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=AIzaSyBL-biUfPdgOoJvqgpD-drdcCNVXERlJ6Y", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email: adminEmail,
          password: "admin-password", // optional: if protected
          returnSecureToken: true
        })
      });

      const tokenInfo = await response.json();
      const usersResp = await fetch(`https://identitytoolkit.googleapis.com/v1/projects/igchkwebsite/accounts:batchGet?key=AIzaSyBL-biUfPdgOoJvqgpD-drdcCNVXERlJ6Y`, {
        headers: {
          Authorization: `Bearer ${tokenInfo.idToken}`
        }
      });

      const usersData = await usersResp.json();
      userListDiv.innerHTML = "";

      for (const user of usersData.users) {
        const userEmail = user.email;

        const fileDoc = await getDoc(doc(db, "userFiles", userEmail));
        const existingUrl = fileDoc.exists() ? fileDoc.data().fileUrl : "";

        const userDiv = document.createElement("div");
        userDiv.className = "user-entry";
        userDiv.innerHTML = `
          <p><strong>${userEmail}</strong></p>
          <input type="text" id="url-${userEmail}" value="${existingUrl}" placeholder="File URL" size="40" />
          <button onclick="saveURL('${userEmail}')">Save</button>
        `;
        userListDiv.appendChild(userDiv);
      }
    }

    window.saveURL = async (email) => {
      const input = document.getElementById("url-" + email);
      const url = input.value.trim();
      await setDoc(doc(db, "userFiles", email), { fileUrl: url });
      alert("Saved for " + email);
    };
  </script>
</body>
</html>

