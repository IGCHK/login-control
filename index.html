<!DOCTYPE html>
<html>
<head>
  <title>IGC HK Admin</title>
  <style>
    body { background-color: #fdf6a6; font-family: Arial; padding: 20px; }
    .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #f2f2f2; }
    input[type="text"] { padding: 8px; width: 100%; border: 1px solid #ddd; border-radius: 4px; }
    button { padding: 8px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .logout-btn { background-color: #f44336; float: right; }
    .verified { background-color: #4CAF50; color: white; padding: 3px 6px; border-radius: 3px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>IGC HK Admin Panel</h1>
    <button class="logout-btn" id="logoutBtn">Logout</button>
    
    <div id="login-container">
      <h2>Admin Login</h2>
      <input type="email" id="adminEmail" placeholder="Admin Email" value="igchkadmin@yourdomain.com">
      <input type="password" id="adminPassword" placeholder="Password">
      <button id="loginBtn">Login</button>
      <p id="login-error" style="color: red;"></p>
    </div>

    <div id="admin-content" style="display: none;">
      <table>
        <thead>
          <tr>
            <th>Email</th>
            <th>Status</th>
            <th>Assigned URL</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="userList"></tbody>
      </table>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    // Import required Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js';
    import { getFirestore, collection, getDocs, doc, setDoc } from 'https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js';

    // Admin Project (igchkadmin) - REPLACE WITH YOUR ACTUAL CONFIG
    const adminConfig = {
      apiKey: "AIzaSyYourAdminApiKeyHere",
      authDomain: "igchkadmin.firebaseapp.com",
      projectId: "igchkadmin",
      storageBucket: "igchkadmin.appspot.com",
      messagingSenderId: "1234567890",
      appId: "1:1234567890:web:abcdef123456"
    };

    // User Project (igchkwebsite - for Firestore access)
    const userConfig = {
      apiKey: "AIzaSyBL-biUfPdgOoJvqgpD-drdcCNVXERlJ6Y",
      authDomain: "igchkwebsite.firebaseapp.com",
      projectId: "igchkwebsite",
      storageBucket: "igchkwebsite.appspot.com"
    };

    // Initialize apps
    const adminApp = initializeApp(adminConfig, "admin");
    const userApp = initializeApp(userConfig, "user");
    
    const adminAuth = getAuth(adminApp);
    const userDb = getFirestore(userApp);

    // DOM Elements
    const loginContainer = document.getElementById("login-container");
    const adminContent = document.getElementById("admin-content");
    const userList = document.getElementById("userList");
    const logoutBtn = document.getElementById("logoutBtn");
    const loginBtn = document.getElementById("loginBtn");

    // Admin Whitelist
    const ADMIN_EMAILS = ["igchkadmin@yourdomain.com"];

    // Login Handler
    loginBtn.addEventListener("click", async () => {
      const email = document.getElementById("adminEmail").value;
      const password = document.getElementById("adminPassword").value;
      const errorEl = document.getElementById("login-error");
      
      try {
        const userCred = await signInWithEmailAndPassword(adminAuth, email, password);
        if (ADMIN_EMAILS.includes(userCred.user.email)) {
          loginContainer.style.display = "none";
          adminContent.style.display = "block";
          loadUsers();
        } else {
          await signOut(adminAuth);
          errorEl.textContent = "Access denied: Not an admin";
        }
      } catch (error) {
        errorEl.textContent = error.message;
      }
    });

    // Load Users from igchkwebsite project
    async function loadUsers() {
      userList.innerHTML = "<tr><td colspan='4'>Loading users...</td></tr>";
      
      try {
        // Get all users from igchkwebsite project
        const idToken = await adminAuth.currentUser.getIdToken();
        const response = await fetch(
          `https://identitytoolkit.googleapis.com/v1/projects/igchkwebsite/accounts:batchGet?key=${userConfig.apiKey}`,
          { headers: { Authorization: `Bearer ${idToken}` } }
        );
        const users = (await response.json()).users || [];

        // Get URL assignments
        const urlSnapshot = await getDocs(collection(userDb, "userFiles"));
        const urlMap = {};
        urlSnapshot.forEach(doc => urlMap[doc.id] = doc.data().fileUrl);

        // Render table
        userList.innerHTML = users.map(user => `
          <tr>
            <td>${user.email}</td>
            <td><span class="verified">${user.emailVerified ? "Verified" : "Pending"}</span></td>
            <td><input type="text" id="url-${user.email}" value="${urlMap[user.email] || ""}"></td>
            <td><button onclick="saveURL('${user.email}')">Save</button></td>
          </tr>
        `).join("");
      } catch (error) {
        userList.innerHTML = `<tr><td colspan="4" style="color:red;">Error: ${error.message}</td></tr>`;
      }
    }

    // Save URL to igchkwebsite Firestore
    window.saveURL = async (email) => {
      const url = document.getElementById(`url-${email}`).value.trim();
      try {
        await setDoc(doc(userDb, "userFiles", email), { 
          fileUrl: url,
          updatedAt: new Date() 
        });
        alert(`Saved URL for ${email}`);
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    };

    // Logout
    logoutBtn.addEventListener("click", () => signOut(adminAuth));

    // Auth state listener
    onAuthStateChanged(adminAuth, (user) => {
      if (user && ADMIN_EMAILS.includes(user.email)) {
        loginContainer.style.display = "none";
        adminContent.style.display = "block";
        loadUsers();
      } else {
        loginContainer.style.display = "block";
        adminContent.style.display = "none";
      }
    });
  </script>
</body>
</html>
