<!DOCTYPE html>
<html>
<head>
  <title>IGC HK Admin Panel</title>
  <style>
    /* [Keep your existing styles] */
  </style>
</head>
<body>
  <!-- [Keep your existing HTML structure] -->

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
    import { 
      getAuth, 
      signInWithEmailAndPassword, 
      signOut, 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      getDocs,
      doc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";

    // Admin Project (igchkadmin)
    const adminConfig = {
      apiKey: "AIzaSyAS5ssOie0tu6OUYWfMdagnt592DAESyJU",
      authDomain: "igchkadmin.firebaseapp.com",
      projectId: "igchkadmin",
      storageBucket: "igchkadmin.firebasestorage.app",
      messagingSenderId: "532987962673",
      appId: "1:532987962673:web:1aaaf1499e1ac3d7547c10"
    };

    // User Project (igchkwebsite)
    const userConfig = {
      apiKey: "AIzaSyBL-biUfPdgOoJvqgpD-drdcCNVXERlJ6Y",
      authDomain: "igchkwebsite.firebaseapp.com",
      projectId: "igchkwebsite",
      storageBucket: "igchkwebsite.appspot.com"
    };

    // Initialize both apps
    const adminApp = initializeApp(adminConfig, "admin");
    const userApp = initializeApp(userConfig, "user");
    
    const adminAuth = getAuth(adminApp);
    const userDb = getFirestore(userApp);

    // [Keep your existing DOM elements and admin emails list]

    // New function to get all users through a Cloud Function
    async function getAllUsers() {
      try {
        const idToken = await adminAuth.currentUser.getIdToken();
        const response = await fetch('https://us-central1-igchkwebsite.cloudfunctions.net/listUsers', {
          headers: {
            'Authorization': `Bearer ${idToken}`
          }
        });
        
        if (!response.ok) throw new Error('Failed to fetch users');
        return await response.json();
      } catch (error) {
        console.error("Error fetching users:", error);
        throw error;
      }
    }

    // Updated loadUsers function
    async function loadUsers(searchTerm = "") {
      userList.innerHTML = "<tr><td colspan='4'>Loading users...</td></tr>";
      
      try {
        // Get all users through Cloud Function
        const users = await getAllUsers();
        
        // Get URL assignments from Firestore
        const urlSnapshot = await getDocs(collection(userDb, "userFiles"));
        const urlMap = {};
        urlSnapshot.forEach(doc => {
          urlMap[doc.id] = doc.data().url || "";
        });

        // Filter and display users
        const filteredUsers = users.filter(user => 
          user.email.toLowerCase().includes(searchTerm.toLowerCase())
        );

        userList.innerHTML = filteredUsers.map(user => `
          <tr>
            <td>${user.email}</td>
            <td><span class="${user.emailVerified ? 'verified' : 'pending'}">
              ${user.emailVerified ? "Verified" : "Pending"}
            </span></td>
            <td><input type="text" id="url-${user.email}" value="${urlMap[user.email] || ""}"></td>
            <td>
              <button onclick="saveURL('${user.email}')">Save</button>
              <button onclick="testURL('${user.email}')">Test</button>
            </td>
          </tr>
        `).join("");

      } catch (error) {
        userList.innerHTML = `<tr><td colspan="4" style="color:red;">Error: ${error.message}</td></tr>`;
      }
    }

    // [Keep the rest of your existing functions]
  </script>
</body>
</html>
